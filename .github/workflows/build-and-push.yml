name: Build and Push to ECR

on:
  push:
    branches: ["main", "ON-89_add_action_for_gitops"]
    tags: ["release-*"]

env:
  AWS_REGION: ap-northeast-2

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      overlay: ${{ steps.meta.outputs.overlay }}
      targets: ${{ steps.meta.outputs.targets }}
      kustomize_targets: ${{ steps.meta.outputs.kustomize_targets }}
    steps:
      - name: Extract metadata
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/release-* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/release-}" >> $GITHUB_OUTPUT
            echo "overlay=prod" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
            echo "overlay=dev" >> $GITHUB_OUTPUT
          fi
          echo 'targets=["hardhat","contracts","gateway","demo","simple-relayer","guide"]' >> $GITHUB_OUTPUT
          echo 'kustomize_targets=["gateway","demo","guide"]' >> $GITHUB_OUTPUT

  build:
    name: Build ${{ matrix.target }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs: setup
    strategy:
      matrix:
        target: ${{ fromJSON(needs.setup.outputs.targets) }}
        arch: [amd64, arm64]
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        env:
          IMAGE: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/solo-pay/${{ matrix.target }}
        with:
          context: .
          file: docker/Dockerfile.packages
          target: ${{ matrix.target }}
          push: true
          tags: ${{ env.IMAGE }}:${{ needs.setup.outputs.tag }}-${{ matrix.arch }}
          cache-from: type=gha,scope=${{ matrix.target }}-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.target }}-${{ matrix.arch }}
          provenance: false

  manifest:
    name: Create manifest ${{ matrix.target }}
    runs-on: ubuntu-latest
    needs: [build, setup]
    strategy:
      matrix:
        target: ${{ fromJSON(needs.setup.outputs.targets) }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create and push manifest
        env:
          IMAGE: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/solo-pay/${{ matrix.target }}
          TAG: ${{ needs.setup.outputs.tag }}
          OVERLAY: ${{ needs.setup.outputs.overlay }}
        run: |
          docker manifest create ${IMAGE}:${TAG} \
            ${IMAGE}:${TAG}-amd64 \
            ${IMAGE}:${TAG}-arm64
          docker manifest push ${IMAGE}:${TAG}

          if [[ "$OVERLAY" == "prod" ]]; then
            MAJOR_MINOR=${TAG%.*}
            docker manifest create ${IMAGE}:${MAJOR_MINOR} \
              ${IMAGE}:${TAG}-amd64 \
              ${IMAGE}:${TAG}-arm64
            docker manifest push ${IMAGE}:${MAJOR_MINOR}

            docker manifest create ${IMAGE}:latest \
              ${IMAGE}:${TAG}-amd64 \
              ${IMAGE}:${TAG}-arm64
            docker manifest push ${IMAGE}:latest
          else
            docker manifest create ${IMAGE}:nightly \
              ${IMAGE}:${TAG}-amd64 \
              ${IMAGE}:${TAG}-arm64
            docker manifest push ${IMAGE}:nightly
          fi

  update-kustomize:
    name: Update Kustomize
    runs-on: ubuntu-latest
    needs: [manifest, setup]
    env:
      TAG: ${{ needs.setup.outputs.tag }}
      OVERLAY: ${{ needs.setup.outputs.overlay }}
    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          repository: globalmsq/solo-pay-infra
          token: ${{ secrets.PAT_TOKEN }}
          path: solo-pay-infra

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Update kustomization
        working-directory: solo-pay-infra/k8s/overlays/${{ env.OVERLAY }}
        env:
          ECR_BASE: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/solo-pay
          TARGETS: ${{ needs.setup.outputs.kustomize_targets }}
        run: |
          for target in $(echo "$TARGETS" | jq -r '.[]'); do
            kustomize edit set image ${ECR_BASE}/${target}=${ECR_BASE}/${target}:${TAG}
          done

      - name: Commit and push
        working-directory: solo-pay-infra
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "chore: update image tag to ${TAG} (${OVERLAY})"
          git push
