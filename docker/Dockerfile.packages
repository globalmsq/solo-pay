# MSQPay Monorepo - Multi-stage Dockerfile
# Targets: hardhat, server, demo

# ============================================
# Base Stage: Common dependencies
# ============================================
FROM node:20-alpine AS base

# 네이티브 모듈 빌드를 위한 도구 설치 (node-gyp 요구사항)
RUN apk add --no-cache git python3 make g++ && \
    npm install -g pnpm@10.23.0

WORKDIR /app

# Copy workspace configuration
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./

# ============================================
# Dependencies Stage
# ============================================
FROM base AS deps

# Copy all package.json files
COPY contracts/package.json ./contracts/
COPY packages/sdk/package.json ./packages/sdk/
COPY packages/pay-server/package.json ./packages/pay-server/
COPY apps/demo/package.json ./apps/demo/

# Install all dependencies with frozen lockfile for reproducible builds
RUN pnpm install --frozen-lockfile

# ============================================
# Hardhat Node Stage
# ============================================
FROM deps AS hardhat

# Copy contracts source
COPY contracts ./contracts

WORKDIR /app/contracts

# Expose Hardhat node port
EXPOSE 8545

# Run Hardhat node with network exposed
CMD ["npx", "hardhat", "node", "--hostname", "0.0.0.0"]

# ============================================
# Server Builder Stage
# ============================================
FROM deps AS server-builder

# Copy server source
COPY packages/pay-server ./packages/pay-server

WORKDIR /app/packages/pay-server

# Build server
RUN pnpm build

# ============================================
# Server Runtime Stage
# ============================================
FROM base AS server

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/packages/pay-server/node_modules ./packages/pay-server/node_modules

# Copy built server
COPY --from=server-builder /app/packages/pay-server/dist ./packages/pay-server/dist
COPY --from=server-builder /app/packages/pay-server/package.json ./packages/pay-server/

WORKDIR /app/packages/pay-server

# Expose server port
EXPOSE 3001

# Run server
CMD ["node", "dist/index.js"]

# ============================================
# SDK Builder Stage (for demo dependency)
# ============================================
FROM deps AS sdk-builder

# Copy SDK source
COPY packages/sdk ./packages/sdk

WORKDIR /app/packages/sdk

# Build SDK
RUN pnpm build

# ============================================
# Demo Builder Stage
# ============================================
FROM deps AS demo-builder

# Copy built SDK from sdk-builder
COPY --from=sdk-builder /app/packages/sdk ./packages/sdk

# Copy demo source
COPY apps/demo ./apps/demo

WORKDIR /app/apps/demo

# Build demo app
RUN pnpm build

# ============================================
# Demo Runtime Stage
# ============================================
FROM base AS demo

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/apps/demo/node_modules ./apps/demo/node_modules

# Copy built demo
COPY --from=demo-builder /app/apps/demo/.next ./apps/demo/.next
COPY --from=demo-builder /app/apps/demo/package.json ./apps/demo/
COPY --from=demo-builder /app/apps/demo/next.config.js ./apps/demo/

WORKDIR /app/apps/demo

# Expose demo port
EXPOSE 3000

# Run demo app
CMD ["pnpm", "start"]

# ============================================
# Mock Defender Dependencies Stage
# ============================================
FROM base AS mock-defender-deps

# Copy mock-defender package.json
COPY packages/mock-defender/package.json ./packages/mock-defender/

# Install dependencies
RUN pnpm install --frozen-lockfile --filter @msqpay/mock-defender

# ============================================
# Mock Defender Builder Stage
# ============================================
FROM mock-defender-deps AS mock-defender-builder

# Copy mock-defender source
COPY packages/mock-defender ./packages/mock-defender

WORKDIR /app/packages/mock-defender

# Build mock-defender
RUN pnpm build

# ============================================
# Mock Defender Runtime Stage
# ============================================
FROM base AS mock-defender

# Copy dependencies from mock-defender-deps stage
COPY --from=mock-defender-deps /app/node_modules ./node_modules
COPY --from=mock-defender-deps /app/packages/mock-defender/node_modules ./packages/mock-defender/node_modules

# Copy built mock-defender
COPY --from=mock-defender-builder /app/packages/mock-defender/dist ./packages/mock-defender/dist
COPY --from=mock-defender-builder /app/packages/mock-defender/package.json ./packages/mock-defender/

WORKDIR /app/packages/mock-defender

# Environment variables
ENV NODE_ENV=production
ENV HOST=0.0.0.0
ENV PORT=3001

# Expose port
EXPOSE 3001

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3001/health || exit 1

# Run server
CMD ["node", "dist/server.js"]
